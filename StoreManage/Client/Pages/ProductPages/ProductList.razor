@page "/products"
@using StoreManage.Shared.Dtos.ProductDtos
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IJSRuntime JS
@layout MainLayout

<h3 class="text-center mb-4">🛒 قائمة المنتجات</h3>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
    </div>
}
else
{
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="🔍 ابحث عن منتج..." @bind="SearchTerm" />
        </div>
        <div class="col-md-4">
            <select class="form-select" @bind="SelectedCategory">
                <option value="">📂 كل التصنيفات</option>
                @foreach (var cat in uniqueCategories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>
        </div>
    </div>

    <div class="row">
        @foreach (var prod in filteredProducts)
        {
            <div class="col-md-4 mb-4">
                <div class="card h-100 position-relative">
                    <img src="@GetImage(prod)" class="card-img-top" style="height: 200px; object-fit: cover; cursor:pointer"
                         @onclick="() => NavigateToDetails(prod.Id)" />

                    <div class="card-body text-center" style="cursor:pointer" @onclick="() => NavigateToDetails(prod.Id)">
                        <h5 class="card-title text-primary fw-bold">@prod.Name</h5>
                        <p class="card-text text-muted">
                            💰 شراء: @prod.LastPurchasePrice<br />
                            🏷️ جملة: @prod.Price1<br />
                            🛍️ قطاعي: @prod.Price2
                        </p>
                    </div>

                    <div class="card-footer bg-white border-0 d-flex justify-content-center gap-2">
                        <a class="btn btn-sm btn-info" href="/products/edit/@prod.Id">✏️ تعديل</a>
                        <button type="button" class="btn btn-sm btn-danger"
                                @onclick="async e => await DeleteProduct(prod.Id)">
                            🗑️ حذف
                        </button>
                        <button type="button" class="btn btn-sm btn-warning"
                                @onclick="async e => await ToggleVisibility(prod.Id)">
                            🙈 إخفاء
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {

    List<ProductSearchDto> products = new();
    List<ProductSearchDto> filteredProducts = new();
    HashSet<string> uniqueCategories = new();

    bool isLoading = true;

    string searchTerm = "";
    string selectedCategory = "";

    string SearchTerm
    {
        get => searchTerm;
        set
        {
            searchTerm = value;
            ApplyFilters();
        }
    }

    string SelectedCategory
    {
        get => selectedCategory;
        set
        {
            selectedCategory = value;
            ApplyFilters();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        products = await Http.GetFromJsonAsync<List<ProductSearchDto>>("api/Product/GetAllShow");

        uniqueCategories = products
            .Select(p => p.CatogryName)
            .Where(c => !string.IsNullOrWhiteSpace(c))
            .ToHashSet();

        ApplyFilters();
        isLoading = false;
    }

    void ApplyFilters()
    {
        filteredProducts = products
            .Where(p =>
                (string.IsNullOrWhiteSpace(SearchTerm) || p.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrWhiteSpace(SelectedCategory) || p.CatogryName == SelectedCategory)
            )
            .ToList();
    }

    void NavigateToDetails(int id)
    {
        NavManager.NavigateTo($"/products/details/{id}");
    }

    async Task DeleteProduct(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "هل أنت متأكد من حذف المنتج؟");
        if (!confirmed)
            return;

        var response = await Http.DeleteAsync($"api/Product/DeleteProduct/{id}");
        if (response.IsSuccessStatusCode)
        {
            var prod = products.FirstOrDefault(p => p.Id == id);
            if (prod != null)
                products.Remove(prod);

            ApplyFilters();
            StateHasChanged();
        }
    }

    async Task ToggleVisibility(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "هل تريد إخفاء المنتج من الفاتورة؟");
        if (!confirmed)
            return;

        var response = await Http.PutAsync($"api/Product/UpdateShowInBill/{id}", null);
        if (response.IsSuccessStatusCode)
        {
            var prod = products.FirstOrDefault(p => p.Id == id);
            if (prod != null)
                products.Remove(prod);

            ApplyFilters();
            StateHasChanged();
        }
    }

    string GetImage(ProductSearchDto prod)
    {
        return !string.IsNullOrEmpty(prod.ThumbnailImageBase64?.Thumbnail)
            ? $"data:{prod.ThumbnailImageBase64.ContentType};base64,{prod.ThumbnailImageBase64.Thumbnail}"
            : "images/no-image.png"; // صورة افتراضية لو مش موجودة
    }
}

